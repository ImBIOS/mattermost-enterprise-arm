name: Check for Mattermost Releases

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if version exists'
        required: false
        default: 'false'
  # Allow external repository to trigger this workflow
  repository_dispatch:
    types: [check-mattermost-release]

permissions:
  contents: write
  packages: write
  actions: read
  pages: read

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check-version.outputs.NEW_VERSION }}
      version_changed: ${{ steps.check-version.outputs.VERSION_CHANGED }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Get current version
        id: current-version
        run: |
          if [ -f mattermost-release.txt ]; then
            CURRENT_VERSION=$(grep "MATTERMOST_VERSION=" mattermost-release.txt | cut -d= -f2)
            echo "Current version: $CURRENT_VERSION"
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "No version file found"
            echo "current_version=none" >> $GITHUB_OUTPUT
          fi

      - name: Get latest Mattermost release
        id: latest-release
        run: |
          # Get the latest release version from GitHub API
          LATEST_VERSION=$(curl -s https://api.github.com/repos/mattermost/mattermost/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          echo "Latest Mattermost release: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Check if new version exists
        id: check-version
        run: |
          CURRENT="${{ steps.current-version.outputs.current_version }}"
          LATEST="${{ steps.latest-release.outputs.latest_version }}"
          
          echo "Current: $CURRENT"
          echo "Latest: $LATEST"
          
          if [ "$CURRENT" = "$LATEST" ]; then
            echo "No new version available"
            echo "new_version=$LATEST" >> $GITHUB_OUTPUT
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "VERSION_CHANGED=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "Force rebuild requested"
            echo "new_version=$LATEST" >> $GITHUB_OUTPUT
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "VERSION_CHANGED=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "New version found: $LATEST (current: $CURRENT)"
          echo "new_version=$LATEST" >> $GITHUB_OUTPUT
          echo "version_changed=true" >> $GITHUB_OUTPUT
          echo "VERSION_CHANGED=true" >> $GITHUB_OUTPUT

      - name: Get Go version from upstream
        id: go-version
        if: steps.check-version.outputs.VERSION_CHANGED == 'true'
        run: |
          # Fetch the .go-version file from the release tag
          GO_VERSION=$(curl -s "https://raw.githubusercontent.com/mattermost/mattermost/${{ steps.check-version.outputs.new_version }}/server/.go-version" | head -1)
          echo "Go version for ${{ steps.check-version.outputs.new_version }}: $GO_VERSION"
          echo "go_version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: Configure Git
        if: steps.check-version.outputs.VERSION_CHANGED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create version file
        if: steps.check-version.outputs.VERSION_CHANGED == 'true'
        run: |
          VERSION="${{ steps.check-version.outputs.new_version }}"
          GO_VERSION="${{ steps.go-version.outputs.go_version }}"
          
          echo "Creating version file for $VERSION with Go $GO_VERSION"
          printf 'MATTERMOST_VERSION=%s\nGO_VERSION=%s\n' "$VERSION" "$GO_VERSION" > mattermost-release.txt
          
          cat mattermost-release.txt

      - name: Commit and push changes
        if: steps.check-version.outputs.VERSION_CHANGED == 'true'
        run: |
          VERSION="${{ steps.check-version.outputs.new_version }}"
          
          git add mattermost-release.txt
          git status
          
          # Create commit message
          git commit -m "Update Mattermost to ${VERSION}

          - Updated from previous version
          - Auto-generated by GitHub Actions
          
          Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          
          # Push to main branch
          git push origin main

          echo "Committed and pushed version update"

      - name: Create release tag
        if: steps.check-version.outputs.VERSION_CHANGED == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const version = '${{ steps.check-version.outputs.new_version }}';
            
            // Create tag if it doesn't exist
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${version}`,
                sha: context.sha
              });
              console.log(`Created tag: ${version}`);
            } catch (error) {
              // Tag might already exist
              if (error.message.includes('already exists')) {
                console.log(`Tag ${version} already exists, updating...`);
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${version}`
                });
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${version}`,
                  sha: context.sha
                });
                console.log(`Updated tag: ${version}`);
              } else {
                throw error;
              }
            }

      - name: Report status
        run: |
          if [ "${{ steps.check-version.outputs.VERSION_CHANGED }}" = "true" ]; then
            echo "‚úÖ New version triggered: ${{ steps.check-version.outputs.new_version }}"
            echo "   - Commit created and pushed to main"
            echo "   - Tag ${{ steps.check-version.outputs.new_version }} created"
            echo "   - release.yml workflow will build ARM binaries"
            echo "   - docker.yml workflow will build and push Docker images"
          else
            echo "‚ÑπÔ∏è No new version available. Current: ${{ steps.check-version.outputs.new_version }}"
          fi

  trigger-release-build:
    needs: check-release
    if: needs.check-release.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger release workflow dispatch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            // Dispatch the release workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yml',
              ref: 'main',
              inputs: {
                force: 'true'
              }
            });
            console.log('Triggered release.yml workflow');

  notify:
    needs: check-release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report final status
        run: |
          if [ "${{ needs.check-release.outputs.version_changed }}" = "true" ]; then
            echo "üéâ Build triggered for Mattermost ${{ needs.check-release.outputs.new_version }}"
            echo ""
            echo "Expected workflow sequence:"
            echo "1. release.yml - Builds ARM binaries (linux/arm, linux/arm64)"
            echo "2. docker.yml - Builds and pushes Docker images"
          else
            echo "‚úÖ No action needed - already at latest version"
          fi
