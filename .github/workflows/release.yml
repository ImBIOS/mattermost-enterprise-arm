name: Package and release
on:
  push:
    branches:
      - main
      - support-**
    paths:
      - 'mattermost-release.txt'
      - 'build.sh'
      - 'app/**'
      - 'db/**'
      - '!.github/workflows/check-mattermost.yml'
      - '!.github/workflows/docker.yml'
  pull_request:
    branches:
      - main
      - support-**
    paths:
      - 'mattermost-release.txt'
      - 'build.sh'
      - 'app/**'
      - 'db/**'
      - '!.github/workflows/check-mattermost.yml'
      - '!.github/workflows/docker.yml'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force rebuild'
        required: false
        default: 'false'

permissions:
  contents: write
  packages: write

concurrency:
  group: release-build-${{ github.ref }}
  cancel-in-progress: ${{ github.event.inputs.force != 'true' }}

env:
  DEBIAN_RELEASE: bookworm
  DOCKER_PWD: /root
  DOCKER_IMAGE: debian:${DEBIAN_RELEASE}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: arm
          - os: linux
            arch: arm64

    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Read version from file
        id: version
        run: |
          if [ -f mattermost-release.txt ]; then
            cat mattermost-release.txt >> $GITHUB_ENV
          else
            echo "MATTERMOST_VERSION=v11.3.0" >> $GITHUB_ENV
            echo "GO_VERSION=1.24.11" >> $GITHUB_ENV
          fi
          echo "Version: $MATTERMOST_VERSION with Go $GO_VERSION"
          echo "Building for ${{ matrix.os }}/${{ matrix.arch }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build using Docker
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          MM_EDITION: sourceavailable
        run: |
          # Run build in Docker with all necessary environment variables
          docker run \
            --rm \
            --tty \
            --mount="type=bind,source=$PWD,destination=${{ env.DOCKER_PWD }}" \
            --workdir="${{ env.DOCKER_PWD }}" \
            -e DEBIAN_RELEASE \
            -e MATTERMOST_VERSION \
            -e GO_VERSION \
            -e MM_EDITION \
            -e GOOS \
            -e GOARCH \
            -e TARGET_OS \
            -e TARGET_ARCH \
            -e MMCTL_RELEASE \
            -e MM_FOCALBOARD_RELEASE \
            "${{ env.DOCKER_IMAGE }}" \
            ./build.sh

      - name: Verify build output
        run: |
          if [ -f "mattermost-$MATTERMOST_VERSION-${{ matrix.os }}-${{ matrix.arch }}.tar.gz" ]; then
            echo "✅ Build successful: mattermost-$MATTERMOST_VERSION-${{ matrix.os }}-${{ matrix.arch }}.tar.gz"
            ls -lh "mattermost-$MATTERMOST_VERSION-${{ matrix.os }}-${{ matrix.arch }}.tar.gz"
          else
            echo "❌ Build artifact not found!"
            ls -la *.tar.gz 2>/dev/null || echo "No tar.gz files found"
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mattermost-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            mattermost-${{ env.MATTERMOST_VERSION }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
            mattermost-${{ env.MATTERMOST_VERSION }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz.sha512sum
          retention-days: 7

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref,'refs/heads/support-') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - name: Prepare release files
        run: |
          ls -la release-artifacts/

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          tag_name: ${{ env.MATTERMOST_VERSION }}
          name: Mattermost ARM Release ${{ env.MATTERMOST_VERSION }}
          body: |
            ## Mattermost ${{ env.MATTERMOST_VERSION }} ARM Release

            This release includes pre-built Mattermost binaries for ARM architectures:
            - **ARM64 (aarch64)** - Raspberry Pi 4/5, AWS Graviton, etc.
            - **ARMv7 (arm)** - Raspberry Pi 3B+, etc.

            ### Files
            - mattermost-${{ env.MATTERMOST_VERSION }}-linux-arm64.tar.gz
            - mattermost-${{ env.MATTERMOST_VERSION }}-linux-arm.tar.gz

            ### SHA512 Checksums
            Included for verification.

            ### Docker Images
            Docker images are built and pushed separately. See the [Docker workflow](../actions/workflows/docker.yml).
          files: |
            release-artifacts/*.tar.gz
            release-artifacts/*.sha512sum
        continue-on-error: true

      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: release-artifacts/mattermost-${{ env.MATTERMOST_VERSION }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
          asset_name: mattermost-${{ env.MATTERMOST_VERSION }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
          asset_content_type: application/gzip
        continue-on-error: true

  cleanup:
    needs: create-release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Report completion
        run: |
          echo "✅ Release workflow completed"
          echo ""
          echo "Artifacts available at: https://github.com/${{ github.repository }}/releases/tag/${{ env.MATTERMOST_VERSION }}"
